name: Deploy Frontend

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: ${{ github.ref_name == 'main' && 'prod' || (github.ref_name == 'develop' && 'dev' || 'staging') }}

permissions:
  id-token: write
  contents: read

jobs:
  test-and-lint:
    name: Test and Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run linter
        run: |
          cd frontend
          npm run lint

      - name: Run tests
        run: |
          cd frontend
          npm test

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test-and-lint
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_FRONTEND }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Frontend

      - name: Get environment variables from Secrets Manager
        id: secrets
        run: |
          SECRET_ID="${{ secrets.PROJECT_NAME }}-frontend-env-${{ env.ENVIRONMENT }}"
          SECRETS=$(aws secretsmanager get-secret-value --secret-id $SECRET_ID --query SecretString --output text)
          
          # Create .env file for build
          echo "$SECRETS" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' > frontend/.env.production
          
          # Set CloudFront distribution ID output
          echo "cloudfront_id=$(echo $SECRETS | jq -r '.CLOUDFRONT_DISTRIBUTION_ID')" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Next.js app
        run: |
          cd frontend
          npm run build
          
          # Next.js output will be in 'out' directory for static export
          # or in '.next' for server-side rendering
          if [ -d "out" ]; then
            echo "BUILD_DIR=out" >> $GITHUB_ENV
          else
            echo "BUILD_DIR=.next" >> $GITHUB_ENV
          fi

      - name: Deploy to S3
        run: |
          S3_BUCKET="${{ secrets.PROJECT_NAME }}-frontend-${{ env.ENVIRONMENT }}"
          
          if [ "${{ env.BUILD_DIR }}" == "out" ]; then
            # Static export
            aws s3 sync frontend/out/ s3://$S3_BUCKET/ --delete
          else
            # Server-side rendering - need to handle differently
            echo "Server-side rendering detected - please configure appropriate deployment"
            # You might want to use AWS Amplify or EC2/ECS for SSR
          fi

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.secrets.outputs.cloudfront_id }} \
            --paths "/*" \
            --output json

      - name: Run Lighthouse CI (optional)
        if: env.ENVIRONMENT == 'prod'
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://${{ steps.secrets.outputs.cloudfront_id }}.cloudfront.net
          budgetPath: ./frontend/lighthouse-budget.json
          uploadArtifacts: true

      - name: Create deployment status check
        if: always()
        run: |
          DEPLOY_URL="https://${{ steps.secrets.outputs.cloudfront_id }}.cloudfront.net"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Frontend deployed successfully to ${{ env.ENVIRONMENT }}"
            echo "üåê Deployment URL: $DEPLOY_URL"
          else
            echo "‚ùå Frontend deployment failed"
            exit 1
          fi
